document.addEventListener('DOMContentLoaded', () => {

    // --- Constants ---
    const CONTENT_TRANSITION_DURATION = 450; // Match CSS --transition-content (0.45s)

    // --- Element Selectors ---
    const sidebarLinks = document.querySelectorAll('.sidebar-nav .nav-link');
    const contentSections = document.querySelectorAll('.main-content .content-section');
    const mainContentArea = document.getElementById('main-content-area');
    const mainContentTitle = document.getElementById('main-content-title');
    const currentYearSpan = document.getElementById('current-year');
    const logoutButton = document.getElementById('logout-button-dropdown');
    const profileMenuContainer = document.querySelector('.profile-menu-container');
    const dropdownNavLinks = document.querySelectorAll('.profile-dropdown .nav-link-trigger');
    const overviewWidgets = document.querySelectorAll('#overview-content .widget.clickable'); // Ensure widgets are only selected from overview initially
    const loadingOverlay = document.getElementById('loading-overlay');
    const pageSpecificCSSLink = document.getElementById('page-specific-css');
    const docusignCSSPath = 'css/docusign_desktop.css'; // Define path here

    let isTransitioning = false;
    // Determine initial active section safely
    let currentActiveSectionId = 'overview-content'; // Default
    const initialActiveSectionHTML = document.querySelector('.content-section.is-active');
    if (initialActiveSectionHTML) {
        currentActiveSectionId = initialActiveSectionHTML.id;
    } else {
        // If no section is marked active in HTML, activate overview
        const overviewSection = document.getElementById('overview-content');
        if (overviewSection) {
            overviewSection.classList.add('is-active');
        } else {
            console.error("Default section #overview-content not found!");
        }
    }


    // --- Initial Setup ---
    function initializeDashboard() {
        console.log("Initializing Dashboard V2.3...");

        // Remove preload class to enable transitions after a short delay
        setTimeout(() => {
            document.body.classList.remove('preload');
            console.log("Preload class removed, transitions enabled.");
        }, 150);

        // Set current year in copyright
        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        // Set initial title and sidebar state based on the active section found in HTML
        const initialLink = document.querySelector(`.sidebar-nav .nav-link[data-target="${currentActiveSectionId}"]`);
        const initialTitle = initialLink ? initialLink.getAttribute('data-title') : "Dashboard";
        if (mainContentTitle) {
            mainContentTitle.textContent = initialTitle;
        }
        updateSidebarActiveState(currentActiveSectionId);

        // Load initial page-specific CSS if needed
        loadPageSpecificCSS(currentActiveSectionId);

        // Render initial calendar if calendar is the active section
        if (currentActiveSectionId === 'calendar-content') {
            console.log("Initial section is calendar, rendering calendar.");
            renderCalendar(calendarCurrentDate); // Ensure calendar setup runs after this
        }

        console.log("Enhanced Dashboard V2.3 Initialized.");
    }

    // --- Core Functions ---

    function loadPageSpecificCSS(targetId) {
        if (!pageSpecificCSSLink) return;

        if (targetId === 'documents-content') {
            if (pageSpecificCSSLink.getAttribute('href') !== docusignCSSPath) {
                console.log("Loading DocuSign CSS");
                pageSpecificCSSLink.setAttribute('href', docusignCSSPath);
            }
        } else {
            if (pageSpecificCSSLink.getAttribute('href') === docusignCSSPath) {
                console.log("Unloading DocuSign CSS");
                pageSpecificCSSLink.setAttribute('href', ''); // Unload the CSS
            }
        }
    }

    function switchContent(targetId, targetTitle = null) {
        if (isTransitioning || !targetId || targetId === currentActiveSectionId) {
            console.log(`Transition blocked: isTransitioning=${isTransitioning}, targetId=${targetId}, currentActiveSectionId=${currentActiveSectionId}`);
            return;
        }
        isTransitioning = true;
        console.log(`Starting transition to: ${targetId}`);
        if (loadingOverlay) loadingOverlay.classList.add('is-active');

        const currentActiveSection = document.getElementById(currentActiveSectionId);
        const nextSection = document.getElementById(targetId);

        if (!nextSection) {
            console.error(`Target section #${targetId} not found.`);
            isTransitioning = false;
            if (loadingOverlay) loadingOverlay.classList.remove('is-active');
            return;
        }

        // --- Load/Unload Page-Specific CSS ---
        loadPageSpecificCSS(targetId);

        // 1. Trigger exit animation for the current section
        if (currentActiveSection) {
            currentActiveSection.classList.add('is-exiting');
            currentActiveSection.classList.remove('is-active');
            console.log(`Exiting section: ${currentActiveSectionId}`);

            // Use transitionend to reliably remove the exiting class after animation
            // Ensure listener is only added once if multiple transitions might occur
            const handleExitTransitionEnd = (event) => {
                // Check if the event is for the main section opacity/transform transition
                if (event.target === currentActiveSection && (event.propertyName === 'opacity' || event.propertyName === 'transform')) {
                    console.log(`Exit transition ended for: ${currentActiveSectionId}`);
                    // Double-check class exists before removing, might have been removed by quick subsequent transition
                    if (currentActiveSection.classList.contains('is-exiting')) {
                         currentActiveSection.classList.remove('is-exiting');
                         console.log(`Removed .is-exiting class from: ${currentActiveSectionId}`);
                    }
                    // It's generally safer to NOT remove the listener here if switchContent can be called rapidly.
                    // Rely on the { once: true } option if supported, or manage state carefully.
                }
            };
             // Attach listener with 'once' to automatically clean up
             currentActiveSection.addEventListener('transitionend', handleExitTransitionEnd, { once: true });

        } else {
            console.warn("No current active section found to exit.");
        }

        // 2. Update Main Title
        if (mainContentTitle) {
             // Try to get title from the link first, fallback to passed title or default
             const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
             const linkTitle = targetLink ? targetLink.getAttribute('data-title') : null;
             mainContentTitle.textContent = targetTitle || linkTitle || "Dashboard Section";
             console.log(`Updated title to: ${mainContentTitle.textContent}`);
        }

        // 3. Prepare and activate the next section
        // Use a short timeout to ensure the exit class is applied and rendering starts
        setTimeout(() => {
            if (nextSection) { // Check again in case of rapid clicks
                nextSection.scrollTop = 0; // Reset scroll position for the new section
                nextSection.classList.add('is-active'); // Add class to trigger entry animation
                console.log(`Activated section: ${targetId}`);
                currentActiveSectionId = targetId; // Update the current active section ID

                 // Render calendar *after* the section becomes active if needed
                if (targetId === 'calendar-content') {
                     console.log("Rendering calendar as section became active.");
                     renderCalendar(calendarCurrentDate);
                }

                // Remove loading overlay slightly after new content starts animating in
                setTimeout(() => {
                    if (loadingOverlay) loadingOverlay.classList.remove('is-active');
                    isTransitioning = false; // Allow new transitions
                    console.log(`Transition finished for: ${targetId}. Ready for next.`);
                }, CONTENT_TRANSITION_DURATION * 0.75); // Remove overlay during the transition, not after

            } else {
                 console.error(`Next section ${targetId} became unavailable during transition timeout.`);
                 isTransitioning = false;
                 if (loadingOverlay) loadingOverlay.classList.remove('is-active');
            }
        }, 50); // Small delay (50ms) to allow exit animation CSS to apply

        // 4. Update Sidebar Active State
        updateSidebarActiveState(targetId);
    }

    function updateSidebarActiveState(targetId) {
        sidebarLinks.forEach(link => {
            const isActive = link.getAttribute('data-target') === targetId;
            link.classList.toggle('active', isActive);
        });
        console.log(`Updated sidebar active state for target: ${targetId}`);
    }

    // --- Event Listeners ---

    // Sidebar Navigation
    sidebarLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const targetId = link.getAttribute('data-target');
            const targetTitle = link.getAttribute('data-title');
            switchContent(targetId, targetTitle);
        });
    });

    // Profile Dropdown Navigation Links
    dropdownNavLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const targetId = link.getAttribute('data-target');
            const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`); // Find matching sidebar link for title
            const targetTitle = targetLink ? targetLink.getAttribute('data-title') : null;
            switchContent(targetId, targetTitle);
            // Optionally close the dropdown here if needed (requires CSS/JS for dropdown state)
             if (profileMenuContainer) {
                // Simple way: lose focus to hide, or add specific class manipulation if needed
                 profileMenuContainer.querySelector('.profile-button')?.blur();
             }
        });
    });

     // Overview Widgets Clicks (Ensure listener attached only once)
    overviewWidgets.forEach(widget => {
        widget.addEventListener('click', () => {
            const targetId = widget.getAttribute('data-link-target');
            if (targetId) {
                 const targetLink = document.querySelector(`.sidebar-nav .nav-link[data-target="${targetId}"]`);
                 const targetTitle = targetLink ? targetLink.getAttribute('data-title') : null;
                 switchContent(targetId, targetTitle);
            } else {
                console.warn("Clicked widget has no data-link-target attribute:", widget);
            }
        });
    });

    // Quick Links in Overview (Using Event Delegation on the container)
    const quickLinksPanel = document.querySelector('#overview-content .quick-links');
    if (quickLinksPanel) {
        quickLinksPanel.addEventListener('click', (event) => {
            const link = event.target.closest('a.nav-link-trigger');
            if (link) {
                event.preventDefault();
                const targetId = link.getAttribute('data-target');
                const targetLink = document.querySelector(`.sidebar-nav .nav-link[data-target="${targetId}"]`);
                const targetTitle = targetLink ? targetLink.getAttribute('data-title') : null;
                switchContent(targetId, targetTitle);
            }
        });
    }


    // Logout Button
    if (logoutButton) {
        logoutButton.addEventListener('click', () => {
            console.log("Logout initiated...");
            // !! IMPORTANT: Add your actual logout logic here (e.g., Firebase auth signout) !!
            alert("Logout Successful (Simulation). Redirecting...");
            // Example: window.location.href = '/login.html'; // Redirect to login page
        });
    }

    // ========================================================================
    // Calendar Component Logic
    // ========================================================================
    const calendarDaysContainer = document.getElementById('calendar-days');
    const monthYearDisplay = document.getElementById('month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const todayBtn = document.getElementById('today-btn');
    let calendarCurrentDate = new Date(); // Date object to track the currently displayed month/year

    function renderCalendar(dateToShow) {
        if (!calendarDaysContainer || !monthYearDisplay) {
            console.error("Calendar elements not found, cannot render.");
            return;
        }

        const year = dateToShow.getFullYear();
        const month = dateToShow.getMonth(); // 0-indexed (0 = Jan, 11 = Dec)
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // Update Month/Year display
        monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

        // Calculate calendar grid days
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0); // Day 0 of next month is last day of current
        const lastDayOfPrevMonth = new Date(year, month, 0);

        const firstDayWeekday = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
        const lastDateOfMonth = lastDayOfMonth.getDate(); // Number of days in the current month
        const lastDateOfPrevMonth = lastDayOfPrevMonth.getDate(); // Last date of the previous month

        // Clear previous calendar days
        calendarDaysContainer.innerHTML = '';

        // --- Add days from the previous month ---
        for (let i = firstDayWeekday; i > 0; i--) {
            const day = lastDateOfPrevMonth - i + 1;
            calendarDaysContainer.appendChild(createDayElement(day, false, true)); // Not current month, is other month
        }

        // --- Add days for the current month ---
        const today = new Date();
        const todayDate = today.getDate();
        const todayMonth = today.getMonth();
        const todayYear = today.getFullYear();

        for (let i = 1; i <= lastDateOfMonth; i++) {
            const isCurrentDay = (i === todayDate && month === todayMonth && year === todayYear);
            const dayElement = createDayElement(i, true, false, isCurrentDay); // Is current month, not other month
            // Add data attribute for easy date selection
            dayElement.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            calendarDaysContainer.appendChild(dayElement);

            // Placeholder: Add random event indicators
            if (Math.random() < 0.2) { // ~20% chance of having events
                addEventIndicators(dayElement);
            }
        }

        // --- Add days from the next month ---
        const totalDaysRendered = firstDayWeekday + lastDateOfMonth;
        // Aim for 6 rows (42 cells) for consistent grid height
        const daysInGrid = totalDaysRendered <= 35 ? 35 : 42;
        const nextMonthDaysNeeded = daysInGrid - totalDaysRendered;

        for (let i = 1; i <= nextMonthDaysNeeded; i++) {
            calendarDaysContainer.appendChild(createDayElement(i, false, true)); // Not current month, is other month
        }
        console.log(`Calendar rendered for ${monthNames[month]} ${year}`);
    }

    function createDayElement(dayNumber, isCurrentMonth, isOtherMonth, isCurrentDay = false) {
        const dayElement = document.createElement('div');
        dayElement.classList.add('calendar-day');

        const dayNumberSpan = document.createElement('span');
        dayNumberSpan.classList.add('day-number');
        dayNumberSpan.textContent = dayNumber;
        dayElement.appendChild(dayNumberSpan);

        if (isOtherMonth) {
            dayElement.classList.add('other-month');
        }
        if (isCurrentDay) {
            dayElement.classList.add('current-day');
        }

        // Add container for event indicators (dots)
        const eventIndicatorsDiv = document.createElement('div');
        eventIndicatorsDiv.classList.add('event-indicators');
        dayElement.appendChild(eventIndicatorsDiv);

        return dayElement;
    }

    // Placeholder function to add random event dots
    function addEventIndicators(dayElement) {
        const indicatorsContainer = dayElement.querySelector('.event-indicators');
        if (!indicatorsContainer) return;

        const eventTypes = ['deadline', 'meeting', 'filing', 'other'];
        const numEvents = Math.floor(Math.random() * 3) + 1; // Add 1 to 3 dots randomly

        for (let i = 0; i < numEvents; i++) {
            const dot = document.createElement('span');
            dot.classList.add('event-dot');
            // Assign a random event type class
            const randomType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            dot.classList.add(`type-${randomType}`);
            dot.title = `Event Type: ${randomType}`; // Add a tooltip
            indicatorsContainer.appendChild(dot);
        }
    }

    // Calendar Navigation Event Listeners
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
            renderCalendar(calendarCurrentDate);
        });
    } else { console.warn("Previous month button not found"); }

    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
            renderCalendar(calendarCurrentDate);
        });
    } else { console.warn("Next month button not found"); }

    if (todayBtn) {
        todayBtn.addEventListener('click', () => {
            const today = new Date();
            // Only re-render if not already showing the current month and year
            if (calendarCurrentDate.getMonth() !== today.getMonth() || calendarCurrentDate.getFullYear() !== today.getFullYear()) {
                calendarCurrentDate = new Date(); // Reset to today
                renderCalendar(calendarCurrentDate);
            }
        });
    } else { console.warn("Today button not found"); }

    // Calendar Day Click Listener (using event delegation)
    if (calendarDaysContainer) {
        calendarDaysContainer.addEventListener('click', (event) => {
            const targetDay = event.target.closest('.calendar-day');

            // Check if a valid day inside the current month was clicked
            if (targetDay && !targetDay.classList.contains('other-month')) {
                const dateStr = targetDay.dataset.date;
                console.log("Clicked on date:", dateStr);

                // Remove selection from previously selected day
                calendarDaysContainer.querySelectorAll('.selected-day').forEach(el => el.classList.remove('selected-day'));

                // Add selection to the clicked day
                targetDay.classList.add('selected-day');

                // --- Placeholder for action ---
                // You could fetch events for this date, open a modal, etc.
                // alert(`Selected date: ${dateStr}`);
            }
        });
    } else { console.error("Calendar days container not found"); }

    // --- Initial Call ---
    initializeDashboard(); // Run setup logic

}); // End DOMContentLoaded
